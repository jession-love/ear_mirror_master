#include "sys_config.h"
#include "typesdef.h"
#include "lib/video/dvp/cmos_sensor/csi.h"
#include "tx_platform.h"
#include "list.h"
#include "dev.h"
#include "hal/i2c.h"


#if DEV_SENSOR_GC0328


SENSOR_INIT_SECTION static const unsigned char GC0328InitTable[CMOS_INIT_LEN]=
{
/*
	0x01,// [7:0]:driver type,0x01:sensor whith ISP; 0x02:ISP; 0x03:sensor whithout isp;	
	
	0x01,0x6E,0x36,0x00,// [7:0]:XCLK(BE)
	0x00,0x01,0x86,0xA0,// [7:0]:BAUDRATE(BE)
	
	0x00,//	[7:0]:chip_ID_addr>>8,when AddrByteNum == 2; 0 when  AddrByteNum == 1
	0xf0,// [7:0]:chip_ID_addr
	0x00,// [7:0]:chip_ID  
	0x9d,//
	0x00,0x00,0x00,0x00,//resverd
	
	0x02,0x80,//image_width
	0x01,0xE0,//image_height
	0x43,// [7:0]:read ID
	0x42,// [7:0]:write ID
	0x01,//	[7:0]:AddrByteNum ; 
	0x01,// [7:0]:DataByteNum
	
	0x04,// [2:0]:ldo_config_para
	0x01,// [7:0]:ID nums
*/
     
	0xfe , 0x80,		// software reset
	0xfc , 0x16,
	0xfc , 0x16,
	0xfc , 0x16,
	0xfc , 0x16,
	0xf1 , 0x00,
	0xf2 , 0x00,
	0xfe , 0x00,
	0x4f , 0x00,
	0x03 , 0x00,
	0x04 , 0xc0,
	0x42 , 0x00,
	0x77 , 0x5a,
	0x78 , 0x40,
	0x79 , 0x56,
	0xfe , 0x00,
	0x0d , 0x01,
	0x0e , 0xe8,
	0x0f , 0x02,
	0x10 , 0x88,
	0x09 , 0x00,
	0x0a , 0x00,
	0x0b , 0x00,
	0x0c , 0x00,
	0x16 , 0x00,
	0x17 , 0x14,	//0x14 is 0' ,0x17 is 180'
	0x18 , 0x0e,
	0x19 , 0x06,
	0x1b , 0x48,
	0x1f , 0xC8,
	0x20 , 0x01,
	0x21 , 0x78,
	0x22 , 0xb0,
	0x23 , 0x04,//0x06  20140519 GC0328C
	0x24 , 0x13, 
	0x26 , 0x00,
	0x50 , 0x01, //crop mode
	0x70 , 0x45,

	//0x05 , 0x00, //hb [11:8]
	//0x06 , 0xde,//0xde,//hb [7:0]
	//0x07 , 0x00,//vb [11:8]
	//0x08 , 0x24,//vb [7:0]
	
	0xfe , 0x01,//
	0x29 , 0x00,//anti-flicker ste<input type="hidden" >p [11:8]
	0x2a , 0x83,//0x83,//anti-flicker step [7:0]
	
	0x2b , 0x02,//exp level 0  14.28fps
	0x2c , 0x0c,//             
	0x2d , 0x02,//exp level 1  12.50fps
	0x2e , 0x0c,//             
	0x2f , 0x02,//exp level 2  10.00fps
	0x30 , 0x0c,//             
	0x31 , 0x02,//exp level 3  7.14fps
	0x32 , 0x0c,//
	
	0xfe , 0x00,//
	0xfe , 0x01,
	0x50 , 0x00,
	0x4f , 0x00,
	0x4c , 0x01,
	0x4f , 0x00,
	0x4f , 0x00,
	0x4f , 0x00,
	0x4f , 0x00,
	0x4f , 0x00, 
	0x4d , 0x30,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,
	0x4d , 0x40,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,
	0x4d , 0x50,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,
	0x4d , 0x60,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,
	0x4d , 0x70,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,	
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04, 
	0x4e , 0x04,	
	0x4e , 0x04,
	0x4e , 0x04,
	0x4f , 0x01,
	0x50 , 0x88,
	0xfe , 0x00,
	0xfe , 0x00, 
	0x27 , 0xb7,
	0x28 , 0x7F,
	0x29 , 0x20,
	0x33 , 0x20,
	0x34 , 0x20,
	0x35 , 0x20,
	0x36 , 0x20,
	0x32 , 0x08,
	0x3b , 0x00, 
	0x3c , 0x00,
	0x3d , 0x00,
	0x3e , 0x00,
	0x47 , 0x00,
	0x48 , 0x00, 
	0x40 , 0x7f, 
	0x41 , 0x26, 
	0x42 , 0xfb,
	0x44 , 0x02, //yuv
	0x45 , 0x00,
	0x46 , 0x03,//0x47,
	0x4f , 0x01,
	0x4b , 0x01,
	0x50 , 0x01, 
	0x7e , 0x0a, 
	0x7f , 0x03, 
	0x81 , 0x15, 
	0x82 , 0x90,
	0x83 , 0x02,
	0x84 , 0xe5,
	0x90 , 0x2c, 
	0x92 , 0x02,
	0x94 , 0x02,
	0x95 , 0x35,
	0xd1 , 0x24,// 0x30 for front
	0xd2 , 0x24,// 0x30 for front
	0xd3 , 0x40,
	0xdd , 0xd3,
	0xde , 0x38,
	0xe4 , 0x88,
	0xe5 , 0x40, 
	0xd7 , 0x0e, 
	0xfe , 0x00,
	0xbf , 0x0e,
	0xc0 , 0x1c,
	0xc1 , 0x34,
	0xc2 , 0x48,
	0xc3 , 0x5a,
	0xc4 , 0x6e,
	0xc5 , 0x80,
	0xc6 , 0x9c,
	0xc7 , 0xb4,
	0xc8 , 0xc7,
	0xc9 , 0xd7,
	0xca , 0xe3,
	0xcb , 0xed,
	0xcc , 0xf2,
	0xcd , 0xf8,
	0xce , 0xfd,
	0xcf , 0xff,
	0xfe , 0x00,
	0x63 , 0x00,
	0x64 , 0x05,
	0x65 , 0x0b,
	0x66 , 0x19,
	0x67 , 0x2e,
	0x68 , 0x40,
	0x69 , 0x54,
	0x6a , 0x66,
	0x6b , 0x86,
	0x6c , 0xa7,
	0x6d , 0xc6,
	0x6e , 0xe4,
	0x6f , 0xff,
	0xfe , 0x01,
	0x18 , 0x02,
	0xfe , 0x00,
	0x97 , 0x30,
	0x98 , 0x00,
	0x9b , 0x60,
	0x9c , 0x60,
	0xa4 , 0x50,
	0xa8 , 0x80,
	0xaa , 0x40,
	0xa2 , 0x23,
	0xad , 0x28,
	0xfe , 0x01,
	0x9c , 0x00, 
	0x9e , 0xc0, 
	0x9f , 0x40,	
	0xfe , 0x01,
	0x08 , 0xa0,
	0x09 , 0xe8,
	0x10 , 0x08,
	0x11 , 0x21,
	0x12 , 0x11,
	0x13 , 0x45,
	0x15 , 0xfc,
	0x18 , 0x02,
	0x21 , 0xf0,
	0x22 , 0x60,
	0x23 , 0x30,
	0x25 , 0x00,
	0x24 , 0x14,
	0x3d , 0x80,
	0x3e , 0x40,
	0xfe , 0x01,
	0x51 , 0x88,
	0x52 , 0x12,
	0x53 , 0x80,
	0x54 , 0x60,
	0x55 , 0x01,
	0x56 , 0x02,
	0x58 , 0x00,
	0x5b , 0x02,
	0x5e , 0xa4,
	0x5f , 0x8a,
	0x61 , 0xdc,
	0x62 , 0xdc,
	0x70 , 0xfc,
	0x71 , 0x10,
	0x72 , 0x30,
	0x73 , 0x0b,
	0x74 , 0x0b,
	0x75 , 0x01,
	0x76 , 0x00,
	0x77 , 0x40,
	0x78 , 0x70,
	0x79 , 0x00,
	0x7b , 0x00,
	0x7c , 0x71,
	0x7d , 0x00,
	0x80 , 0x70,
	0x81 , 0x58,
	0x82 , 0x98,
	0x83 , 0x60,
	0x84 , 0x58,
	0x85 , 0x50,
	0xfe , 0x00,	
	0xfe , 0x01,
	0xc0 , 0x10,
	0xc1 , 0x0c,
	0xc2 , 0x0a,
	0xc6 , 0x0e,
	0xc7 , 0x0b,
	0xc8 , 0x0a,
	0xba , 0x26,
	0xbb , 0x1c,
	0xbc , 0x1d,
	0xb4 , 0x23,
	0xb5 , 0x1c,
	0xb6 , 0x1a,
	0xc3 , 0x00,
	0xc4 , 0x00,
	0xc5 , 0x00,
	0xc9 , 0x00,
	0xca , 0x00,
	0xcb , 0x00,
	0xbd , 0x00,
	0xbe , 0x00,
	0xbf , 0x00,
	0xb7 , 0x07,
	0xb8 , 0x05,
	0xb9 , 0x05,
	0xa8 , 0x07,
	0xa9 , 0x06,
	0xaa , 0x00,
	0xab , 0x04,
	0xac , 0x00,
	0xad , 0x02,
	0xae , 0x0d,
	0xaf , 0x05,
	0xb0 , 0x00,
	0xb1 , 0x07,
	0xb2 , 0x03,
	0xb3 , 0x00,
	0xa4 , 0x00,
	0xa5 , 0x00,
	0xa6 , 0x00,
	0xa7 , 0x00,
	0xa1 , 0x3c,
	0xa2 , 0x50,
	0xfe , 0x00,
	0xb1 , 0x12,
	0xb2 , 0xf5,
	0xb3 , 0xfe,
	0xb4 , 0xe0,
	0xb5 , 0x15,
	0xb6 , 0xc8,
	0xfe , 0x01,
	0x50 , 0x00,
	0xfe , 0x01, 
	0x4f , 0x00,
	0x4c , 0x01,
	0x4f , 0x00,
	0x4f , 0x00,
	0x4f , 0x00, 
	0x4d , 0x34,
	0x4e , 0x04,
	0x4e , 0x04,
	0x4e , 0x02,
	0x4e , 0x02,
	0x4d , 0x44,
	0x4e , 0x04,
	0x4e , 0x04,
	0x4e , 0x04,
	0x4d , 0x53,
	0x4e , 0x00,
	0x4e , 0x04,
	0x4e , 0x04,
	0x4e , 0x04,
	0x4d , 0x65,
	0x4e , 0x04,
	0x4d , 0x73,
	0x4e , 0x20,
	0x4d , 0x83,
	0x4e , 0x20,
	0x4f , 0x01, 
	0x50 , 0x88, 
	0xfe , 0x00,  
	0xf1 , 0x07, 
	0xf2 , 0x01, 
	0xfe , 0x00,
	0x59 , 0x11,  
	0x5a , 0x0e,  //0x03
	0x5b , 0x00, 
	0x5c , 0x00, 
	0x5d , 0x00, 
	0x5e , 0x00, 
	0x5f , 0x00, 
	0x60 , 0x00, 
	0x61 , 0x00, 
	0x62 , 0x00, 
	0x50 , 0x01,
	0x51 , 0x00,  
	0x52 , 0x00, 
	0x53 , 0x00, 
	0x54 , 0x00, 
	0x55 , 0x01, 
	0x56 , 0xe0, 
	0x57 , 0x02, 
	0x58 , 0x80, 
	0xfe , 0x00,
	0xfe , 0x00,
    0x42 , 0xfe,
    0x77 , 0x57,
    0x78 , 0x4d,
    0x79 , 0x45,
-1,-1};

extern struct i2c_device *iic_test;

static void GC0328_rotate(uint32 r)
{
	unsigned char buf[2];
	buf[0] = 0x17;		//0',180'
	buf[1] = 0x14|(r<<0);
	//Sensor_WriteRegister(SENSOR_IIC,buf,1,1);
	//i2c_sensor_write(iic_test,buf,1,1,0x42,0x43);
	//i2c_write(iic_test,(int8 *)&t[i][0],1,(int8 *)&t[i][1],1);
	i2c_write(iic_test,buf,1,&buf[1],1);

}



uint32 GC0328_hvblank(int8 dh,int8 dv)
{
#define HBLANK_BASE	0xdeUL
#define VBLANK_BASE	0x24UL
	uint32 i;
	int32 h = (int32)HBLANK_BASE + dh; if(h < 0) h = 0;
	int32 v = (int32)VBLANK_BASE + dv; if(v < 0) v = 0;
	const uint8 t[][2] = {
		{0x05,h >> 8},//HB[11:8]
		{0x06,h & 0xff},//HB[7:0]
		{0x07,v >> 8},//VB[11:8]
		{0x08,v & 0xff},//VB[7:0]
	};
	
	for(i=0;i<4;i++)	
		i2c_write(iic_test,(int8 *)&t[i][0],1,(int8 *)&t[i][1],1);
	
	return (h<<16)|v;
}

SENSOR_OP_SECTION const _Sensor_Adpt_ gc0328_cmd= 
{
	.typ = 1, //YUV
	.pixelw = 640,
	.pixelh= 480,
	.hsyn = 1,
	.vsyn = 1,
	.rduline = 0,//
	.rawwide = 1,//10bit
	.colrarray = 2,//0:_RGRG_ 1:_GRGR_,2:_BGBG_,3:_GBGB_
	.init = (uint8 *)GC0328InitTable,
	.rotate_adapt = {0},
	//.hvb_adapt = {0x6a,0x12,0x6a,0x12},
	. mclk = 24000000,
	.p_fun_adapt = {GC0328_rotate,GC0328_hvblank,NULL},
	//.p_xc7016_adapt = NULL,	
};

const _Sensor_Ident_ gc0328_init=
{
	0x9d,0x42,0x43,0x01,0x01,0xf0
};



#endif


